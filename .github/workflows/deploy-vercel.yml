# REFERENCES:
# https://dev.to/pierresaid/deploy-node-projects-to-github-pages-with-github-actions-4jco
# https://github.com/rrbutani/use-nix-shell-action?tab=readme-ov-file#example
# https://kit.svelte.dev/docs/adapter-static#github-pages
# https://github.com/skywarth/country-routing-algorithm-demo-vue/blob/master/.github/workflows/deploy-to-github-actions.yml
# https://vercel.com/guides/how-can-i-use-github-actions-with-vercel

name: Vercel Production Deployment
on:
    # Runs on pushes targeting the main branch
    push:
        branches: ["main"]
    # Allow running this workflow manually from the Actions tab
    workflow_dispatch:
# Allow only one concurrent deployment, but don't cancel in-progress ones
concurrency:
    group: "pages"
    cancel-in-progress: false
jobs:
    deploy-prod:
        runs-on: ubuntu-latest
        environment:
            name: vercel
        steps:
          - name: Checkout
            uses: actions/checkout@v3
            # Setup Nix and enter the flake shell
          - name: Install Nix
            uses: cachix/install-nix-action@v18
            with:
                nix_path: nixpkgs=channel:nixos-unstable
          - name: Use Nix Shell
            uses: rrbutani/use-nix-shell-action@v1
            # This is easier than running the commands manually, and actually passes commit metadata
          - name: Deploy to Vercel Action
            uses: EvanNotFound/vercel-deployment-for-github-actions@v1
            with:
                ALIAS_DOMAINS: justinschaaf.com
                GITHUB_DEPLOYMENT_ENV: vercel
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
                VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
                VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
                BUILD_ENV: |
                    PUBLIC_GITHUB_REPOSITORY="${{ github.repository }}"
                    PUBLIC_GITHUB_REF_NAME="${{ github.ref_name }}"
                    PUBLIC_GITHUB_SHA="${{ github.sha }}"
